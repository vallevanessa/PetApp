<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PetApp - Home</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<header class="app-header">
    <h1>Home</h1>
</header>

<!-- Feed Section -->
<div id="feed">
    <p>Loading posts...</p>
</div>

<nav class="bottom-nav">
    <a href="{{ url_for('home') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/home-icon.png') }}" alt="Home" />
        <span>Home</span>
    </a>
    <a href="{{ url_for('search') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/search-icon.png') }}" alt="Search" />
        <span>Search</span>
    </a>
    <a href="{{ url_for('map_page') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/map-icon.png') }}" alt="Map" />
        <span>Map</span>
    </a>
    <a href="{{ url_for('profile') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/profile-icon.png') }}" alt="Profile" />
        <span>Profile</span>
    </a>
</nav>

<script>
  // Fetch posts from the backend and display them
  function fetchPosts() {
      fetch('/fetch_posts')
          .then(response => response.json())
          .then(posts => {
              const feed = document.getElementById('feed');
              feed.innerHTML = ''; // Clear "Loading" message

              // Loop through posts and display them
              posts.forEach(post => {
                  const postElement = document.createElement('div');
                  postElement.classList.add('post');

                  postElement.innerHTML = `
                      <h3>${post.username}</h3>
                      <img src="${post.image_url}" alt="Post Image">
                      <p>${post.content}</p>
                      <small>Posted on: ${new Date(post.created_at).toLocaleString()}</small>
                      <p id="like-count-${post.post_id}">${post.like_count} likes</p>
                      <button class="like-button" data-post-id="${post.post_id}" data-liked="${post.user_liked}">${post.user_liked ? 'üíî Unlike' : '‚ù§Ô∏è Like'}</button>
                      <form class="comment-form" data-post-id="${post.post_id}">
                          <textarea name="content" placeholder="Write a comment..." required></textarea>
                          <button type="submit">Comment</button>
                      </form>
                      <div class="comments" id="comments-${post.post_id}">
                          <p>Loading comments...</p>
                      </div>
                  `;
                  feed.appendChild(postElement);

                  // Load comments for the post
                  loadComments(post.post_id);
              });
          })
          .catch(error => {
              console.error('Error fetching posts:', error);
              const feed = document.getElementById('feed');
              feed.innerHTML = '<p>Failed to load posts.</p>';
          });
  }

  // Function to load comments for a specific post
  function loadComments(postId) {
      fetch(`/fetch_comments?post_id=${postId}`)
          .then(response => response.json())
          .then(comments => {
              const commentsDiv = document.getElementById(`comments-${postId}`);
              if (comments.length === 0) {
                  commentsDiv.innerHTML = '<p>No comments yet.</p>';
                  return;
              }

              commentsDiv.innerHTML = ''; // Clear the "Loading comments..." text
              comments.forEach(comment => {
                  const commentElement = document.createElement('p');
                  commentElement.innerHTML = `<strong>${comment.username}</strong>: ${comment.content}`;
                  commentsDiv.appendChild(commentElement);
              });
          })
          .catch(error => {
              console.error('Error fetching comments:', error);
              const commentsDiv = document.getElementById(`comments-${postId}`);
              commentsDiv.innerHTML = '<p>Failed to load comments.</p>';
          });
  }

  // Listen for like button clicks
  document.addEventListener('click', function (event) {
      if (event.target.matches('.like-button')) {
          const button = event.target;
          const postId = button.getAttribute('data-post-id');
          const liked = button.getAttribute('data-liked') === 'true';
          const userId = 1; // Replace with dynamic user_id when available

          fetch('/like_post', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                  post_id: postId,
                  user_id: userId,
              }),
          })
          .then(response => response.json())
          .then(data => {
              const likeCountElement = document.querySelector(`#like-count-${postId}`);
              if (data.liked) {
                  button.textContent = 'üíî Unlike';
                  button.setAttribute('data-liked', 'true');
                  likeCountElement.textContent = `${parseInt(likeCountElement.textContent) + 1} likes`;
              } else {
                  button.textContent = '‚ù§Ô∏è Like';
                  button.setAttribute('data-liked', 'false');
                  likeCountElement.textContent = `${parseInt(likeCountElement.textContent) - 1} likes`;
              }
          })
          .catch(error => {
              console.error('Error liking post:', error);
          });
      }
  });

  // Listen for comment form submissions
  document.addEventListener('submit', function (event) {
      if (event.target.matches('.comment-form')) {
          event.preventDefault(); // Prevent the default form submission

          const form = event.target;
          const postId = form.getAttribute('data-post-id'); // Get post_id from the form's data attribute
          const content = form.querySelector('textarea[name="content"]').value;

          if (!postId) {
              console.error('Error: post_id is missing.');
              return;
          }

          // Send the comment to the backend
          fetch('/add_comment', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                  post_id: postId,
                  user_id: 1, // Hardcoding user_id for now, replace with dynamic user_id if available
                  content: content,
              }),
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Failed to add comment');
              }
              return response.json();
          })
          .then(data => {
              console.log('Comment added:', data);
              // Reload comments for the post
              loadComments(postId);
              form.reset(); // Clear the comment form
          })
          .catch(error => {
              console.error('Error adding comment:', error);
          });
      }
  });

  // Fetch posts when the page loads
  fetchPosts();
</script>

</body>
</html>
