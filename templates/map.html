<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetApp - Map</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 80vh;
            width: 100%;
        }

        .filter-buttons {
            text-align: center;
            margin: 10px;
        }

        .filter-buttons button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .filter-buttons button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>

    <h2 style="text-align: center;">Find Pet-Friendly Places</h2>


    <div class="filter-buttons">
        <button onclick="showShelters()">Pet Shelters</button>
        <button onclick="showParks()">Pet Parks</button>
        <button onclick="showStores()">Pet Food Stores</button>
    </div>


    <div id="map"></div>

    <!-- Leaflet.js Script -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
 
        const map = L.map('map').setView([37.3653, -120.4394], 12); // UC Merced location

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];

        function addMarker(lat, lon, title) {
            const marker = L.marker([lat, lon]).addTo(map);
            marker.bindPopup(title).openPopup();
            markers.push(marker);
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }


function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; 
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distanceKm = R * c; 


  const distanceMiles = distanceKm * 0.621371; 
  return distanceMiles.toFixed(2); 
}

function getNearbyLocations(type, query) {
  const apiKey = 'YOUR_GOOGLE_API_KEY'; 
  const userLocation = { lat: 37.3653, lon: -120.4394 }; // UC Merced location

  const url = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${userLocation.lat},${userLocation.lon}&radius=5000&keyword=${query}&key=${apiKey}`;

  fetch(url)
    .then(response => response.json())
    .then(data => {
      const results = data.results;
      clearMarkers();  


      results.forEach(result => {
        const lat = result.geometry.location.lat;
        const lon = result.geometry.location.lng;
        const name = result.name;
        const address = result.vicinity; // Address
        const distance = calculateDistance(userLocation.lat, userLocation.lon, lat, lon); // Get the distance in miles


        if (type === "animal_shelter" && name.toLowerCase().includes("shelter")) {
          addMarker(lat, lon, `${name} (${distance} miles away) - ${address}`);
        } else if (type === "park" && name.toLowerCase().includes("park")) {
          addMarker(lat, lon, `${name} (${distance} miles away) - ${address}`);
        } else if (type === "pet_store" && (name.toLowerCase().includes("pet") || name.toLowerCase().includes("store"))) {
          addMarker(lat, lon, `${name} (${distance} miles away) - ${address}`);
        }
      });
    })
    .catch(error => {
      console.log("Error fetching data:", error);
    });
}

// Show Shelters
function showShelters() {
  getNearbyLocations('animal_shelter', 'pet shelter');
}

// Show Parks
function showParks() {
  getNearbyLocations('park', 'pet park');
}

// Show Stores
function showStores() {
  getNearbyLocations('pet_store', 'pet food store');
}

    </script>

<nav class="bottom-nav">
    <a href="{{ url_for('home') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/home-icon.png') }}" alt="Home" />
        <span>Home</span>
    </a>
    <a href="{{ url_for('search') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/search-icon.png') }}" alt="Search" />
        <span>Search</span>
    </a>
    <a href="{{ url_for('map_page') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/map-icon.png') }}" alt="Map" />
        <span>Map</span>
    </a>
    <a href="{{ url_for('profile') }}" class="nav-item">
        <img src="{{ url_for('static', filename='assets/profile-icon.png') }}" alt="Profile" />
        <span>Profile</span>
    </a>
</nav>
</body>

</html>